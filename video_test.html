<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DeepGuard AI - Video File Analysis</title>
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            background: #0f172a;
            color: white;
            text-align: center;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: auto;
            background: #1e293b;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        video {
            width: 100%;
            max-width: 640px;
            border-radius: 8px;
            border: 2px solid #334155;
            margin-top: 10px;
        }

        .stats {
            margin-top: 20px;
            text-align: left;
            background: #000;
            padding: 15px;
            border-radius: 6px;
            font-family: monospace;
        }

        .risk-bar {
            height: 10px;
            border-radius: 5px;
            background: #334155;
            margin-top: 5px;
            overflow: hidden;
        }

        .risk-fill {
            height: 100%;
            width: 0%;
            background: #22c55e;
            transition: width 0.3s, background 0.3s;
        }

        button,
        input::file-selector-button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            transition: 0.2s;
        }

        button:hover,
        input::file-selector-button:hover {
            background: #2563eb;
        }

        input[type="file"] {
            margin: 20px 0;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }

        .metric-box {
            background: #334155;
            padding: 10px;
            border-radius: 6px;
            text-align: center;
        }

        .metric-val {
            font-size: 1.2em;
            font-weight: bold;
            color: #38bdf8;
        }

        .metric-label {
            font-size: 0.8em;
            color: #94a3b8;
        }
    </style>
</head>

<body>

    <div class="container">
        <h1>üïµÔ∏è DeepGuard Video Forensics</h1>
        <p>Upload a video to analyze it for Deepfake traces.</p>

        <input type="file" id="videoInput" accept="video/*">

        <div style="position: relative;">
            <video id="videoPlayer" controls playsinline loops></video>
            <canvas id="frameCanvas" style="display:none;"></canvas>
        </div>

        <br>
        <button id="startBtn" disabled>‚ñ∂Ô∏è Start Analysis</button>
        <button id="stopBtn" disabled style="background: #ef4444;">‚èπÔ∏è Stop</button>

        <div class="stats">
            <h3>üìä Analysis Dashboard</h3>

            <div class="dashboard-grid">
                <div class="metric-box">
                    <div class="metric-val" id="val-risk">0%</div>
                    <div class="metric-label">Risk Score</div>
                </div>
                <div class="metric-box">
                    <div class="metric-val" id="val-variance">0.00</div>
                    <div class="metric-label">Pixel Variance</div>
                </div>
            </div>

            <div style="margin-top: 15px;">
                <label>Liveness Confidence</label>
                <div class="risk-bar">
                    <div id="risk-fill" class="risk-fill"></div>
                </div>
            </div>

            <div class="dashboard-grid">
                <div class="metric-box">
                    <div class="metric-val" id="val-pitch">0¬∞</div>
                    <div class="metric-label">Pitch</div>
                </div>
                <div class="metric-box">
                    <div class="metric-val" id="val-yaw">0¬∞</div>
                    <div class="metric-label">Yaw</div>
                </div>
            </div>

            <p style="margin-top: 15px; color: #facc15;" id="anomalies-text">No anomalies detected.</p>
        </div>

        <div id="logs"
            style="height: 150px; overflow-y: auto; background: #111; color: #0f0; padding: 10px; margin-top: 20px; text-align: left; font-size: 12px; border-radius: 6px;">
            [System] Ready for upload...
        </div>
    </div>

    <script>
        const videoInput = document.getElementById('videoInput');
        const videoPlayer = document.getElementById('videoPlayer');
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const canvas = document.getElementById('frameCanvas');
        const ctx = canvas.getContext('2d');
        const logs = document.getElementById('logs');

        let socket = null;
        let analysisInterval = null;
        const BACKEND_URL = "ws://localhost:8000/ws/analyze";

        function log(msg) {
            logs.innerHTML += `<div>> ${msg}</div>`;
            logs.scrollTop = logs.scrollHeight;
        }

        videoInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const url = URL.createObjectURL(file);
                videoPlayer.src = url;
                startBtn.disabled = false;
                log(`Loaded video: ${file.name}`);
            }
        });

        startBtn.addEventListener('click', () => {
            if (!socket || socket.readyState !== WebSocket.OPEN) {
                connectAndStart();
            } else {
                startProcessing();
            }
        });

        stopBtn.addEventListener('click', () => {
            stopProcessing();
        });

        function connectAndStart() {
            log("Connecting to DeepGuard Analysis Engine...");
            socket = new WebSocket(BACKEND_URL);

            socket.onopen = () => {
                log("‚úÖ Connected! Starting analysis loop...");
                startProcessing();
            };

            socket.onmessage = (event) => {
                const report = JSON.parse(event.data);
                updateDashboard(report);
            };

            socket.onclose = () => {
                log("‚ùå Disconnected from server.");
                stopProcessing();
            };

            socket.onerror = (e) => {
                log("‚ö†Ô∏è WebSocket Error. Ensure server.py is running.");
            };
        }

        function startProcessing() {
            videoPlayer.play();
            startBtn.disabled = true;
            stopBtn.disabled = false;

            // Capture frame every 200ms (5 FPS)
            analysisInterval = setInterval(() => {
                if (videoPlayer.paused || videoPlayer.ended) return;

                canvas.width = 320;
                canvas.height = 240;
                ctx.drawImage(videoPlayer, 0, 0, canvas.width, canvas.height);

                const frameData = canvas.toDataURL('image/jpeg', 0.6);

                if (socket && socket.readyState === WebSocket.OPEN) {
                    socket.send(JSON.stringify({
                        type: 'video_frame',
                        payload: frameData
                    }));
                }
            }, 200);
        }

        function stopProcessing() {
            clearInterval(analysisInterval);
            videoPlayer.pause();
            startBtn.disabled = false;
            stopBtn.disabled = true;
            if (socket) socket.close();
            log("üõë Analysis stopped.");
        }

        function updateDashboard(report) {
            // Update Risk Score
            document.getElementById('val-risk').innerText = report.risk_score + "%";

            // Color code risk
            const riskFill = document.getElementById('risk-fill');
            riskFill.style.width = report.risk_score + "%";
            if (report.risk_score < 30) riskFill.style.background = "#22c55e"; // Green
            else if (report.risk_score < 70) riskFill.style.background = "#f97316"; // Orange
            else riskFill.style.background = "#ef4444"; // Red

            // Update Anomalies
            const anomaliesBox = document.getElementById('anomalies-text');
            if (report.anomalies.length > 0) {
                anomaliesBox.innerText = "‚ö†Ô∏è " + report.anomalies.join(", ");
                anomaliesBox.style.color = "#ef4444";
                log(`ANOMALY: ${report.anomalies.join(", ")}`);
            } else {
                anomaliesBox.innerText = "‚úÖ No anomalies detected.";
                anomaliesBox.style.color = "#22c55e";
            }

            // Update Debug Info
            if (report.debug_info) {
                document.getElementById('val-pitch').innerText = (report.debug_info.pitch || 0).toFixed(1) + "¬∞";
                document.getElementById('val-yaw').innerText = (report.debug_info.yaw || 0).toFixed(1) + "¬∞";
                // document.getElementById('val-variance').innerText = (report.debug_info.variance || 0).toFixed(3);

                // Show pixel variance if available (simulated or real from logs)
                // Note: The backend currently sends 'variance' as head movement variance.
            }
        }
    </script>
</body>

</html>